â€‹// ==UserScript==
// @name          Blog Table â­
// @namespace    http://tampermonkey.net/
// @version       3.7
// @description  ç·¨é›†ç”»é¢ä¸Šã«tableè¡¨ã‚’ä½œæˆã™ã‚‹
// @author        Ameba Blog User
// @match        https://blog.ameba.jp/ucs/entry/srventry*
// @exclude      https://blog.ameba.jp/ucs/entry/srventrylist.do*
// @grant         none
// ==/UserScript==


let retry=0;
let interval=setInterval(wait_target, 100);
function wait_target(){
    retry++;
    if(retry>10){ // ãƒªãƒˆãƒ©ã‚¤åˆ¶é™ 10å› 1sec
        clearInterval(interval); }
    let target=document.getElementById('cke_1_contents'); // ç›£è¦– target
    if(target){
        clearInterval(interval);
        main(); }}



function main(){
    let ua=0; // Chromeã®å ´åˆã®ãƒ•ãƒ©ã‚°
    let agent=window.navigator.userAgent.toLowerCase();
    if(agent.indexOf('firefox') > -1){ ua=1; } // Firefoxã®å ´åˆã®ãƒ•ãƒ©ã‚°

    let task=0; // èµ·å‹•1ãƒ»ä½œæˆ2ãƒ»æ›´æ–°3ãƒ»çµ‚äº†0
    let trim=0; // è¿½åŠ 0ãƒ»å‰Šé™¤1
    let cell_set=0; // ã‚»ãƒ«å¹…è¨­å®šãƒ‘ãƒãƒ«ã®åˆ—é¸æŠ

    let posit_set; // ä¸­å¤®å¯„ã›ãƒ»å·¦å¯„ã›
    let table_position;
    let border_collapse;
    let add_padd; // td ã®paddingå€¤
    let layout_fix; // table-layoutè¨­å®š
    let table_border_width;
    let cell_border_width;
    let border_space;
    let left_full; // å·¦ç«¯èƒŒæ™¯è‰²ã®å„ªå…ˆ
    let color_input=[]; // 4å€‹ã®ã‚«ãƒ©ãƒ¼è¨­å®šæ 
    let setting=[];
    let word_break; // è‹±æ–‡ç¦å‰‡


    if(read_locals()){
        setting=read_locals(); }
    if(setting.length!=18){
        setting=['BlogTable','3','3','0','580','620','0.6','1',' tr:not(:first-child)',
                 '#999','#F4F4F4','#F4F4F4','#FFF','16','auto','break-all','','']; }
    write_locals(setting);


    function read_locals(){
        let read_json=localStorage.getItem('BlogTable'); // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜å
        return JSON.parse(read_json); }

    function write_locals(data){
        let write_json=JSON.stringify(data);
        localStorage.setItem('BlogTable', write_json); } // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜



    let target=document.getElementById('cke_1_contents'); // ç›£è¦– target
    let monitor=new MutationObserver( catch_key );
    monitor.observe(target, {childList: true, attributes: true}); // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå¾…å—ã‘é–‹å§‹

    catch_key();

    function catch_key(){
        if(document.querySelector('.cke_wysiwyg_frame') !=null){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ã‹ã‚‰å®Ÿè¡Œé–‹å§‹
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            let iframe_doc=editor_iframe.contentWindow.document;

            iframe_doc.addEventListener('keydown', check_key);
            document.addEventListener('keydown', check_key);

            function check_key(event){
                if(event.keyCode==13 && iframe_doc.hasFocus()){
                    remove_mark(); } // æ”¹è¡Œå…¥åŠ›ãŒé€£ç¶šãƒãƒ¼ã‚¯ã¨ãªã‚‹ã®ã‚’æŠ‘æ­¢

                let gate=-1;
                if(event.ctrlKey==true){
                    if(event.keyCode==112){
                        event.preventDefault(); gate=1; }
                    if(gate==1){
                        event.stopImmediatePropagation();
                        do_task(); }}}

            function do_task(){
                if(task==0){
                    task=1;
                    table_panel();
                    enhanced(); }
                else{
                    task=0;
                    remove_t_panel();
                    remove_mark_all(); }}}

        before_end();

    } // catch_key()



    function table_panel(){

        let panel=
            '<div id="t_panel">'+
            '<span class="t_label">æ§‹æˆ</span>'+
            '<div class="wnc"><input id="col" type="number" min="1"></div>'+
            '<div class="wnr"><input id="row" type="number" min="1"></div>'+
            '<span class="t_label">é…ç½®</span>'+
            '<input id="wide" type="submit" value="ã€€">'+
            '<span class="t_label">è¡¨å¹…</span>'+
            '<div class="wpxt"><input id="t_width" type="number" min="10" max="1000"></div>'+
            '<input id="t_width_m" type="submit" value="Ğ¼">'+
            '<input id="td_padd" type="submit" value="ã€€">'+
            '<input id="equal" type="submit" value="ã€€">'+
            '<span class="t_label">æ ç·š</span>'+
            '<div class="wpx"><input id="border_width" type="number" min="-9"></div>'+
            '<input id="border_color" type="text" autocomplete="off">'+
            '<span class="t_label">æœ€ä¸Šè¡ŒèƒŒæ™¯</span>'+
            '<input id="header_back" type="text" autocomplete="off">'+
            '<span class="t_label">å·¦ç«¯åˆ—èƒŒæ™¯</span>'+
            '<input id="left_back" type="text" autocomplete="off">'+
            '<input id="left_back_f" type="submit" value="â–²">'+
            '<span class="t_label">å…¨ä½“èƒŒæ™¯</span>'+
            '<input id="cell_back" type="text" autocomplete="off">'+
            '<span class="t_label">æ–‡å­—</span>'+
            '<div class="wpx"><input id="t_font" type="number" min="12" max="32"></div>'+
            '<input id="copy" type="submit" value="C">'+
            '<input id="set" type="submit" value="ã€€">'+
            '<span id="test"></span>'+

            '<div id="first">'+
            '<span id="bt_help">ï¼Ÿ</span>'+
            '<div class="bt_help1">'+
            'è¡¨ã‚’ä½œæˆã™ã‚‹å ´æ‰€ / æ›´æ–°ã™ã‚‹è¡¨ã‚’<b>ã€ŒCtrl+å·¦Clickã€</b>ã§æŒ‡å®šã—ã¦ãã ã•ã„</div>'+
            '<div class="bt_help2">'+
            'TRIMå‡¦ç†ï¼šå·¦ç«¯åˆ—ãƒ»æœ€ä¸Šè¡Œã‚’<b>ã€ŒAlt+å·¦Clickã€</b>ã—ã¦ å‰Šé™¤ã™ã‚‹åˆ—ãƒ»è¡Œ'+
            'ï¼ˆè¿½åŠ ã®å ´åˆã¯å¾Œæ–¹ã®åˆ—ãƒ»è¡Œï¼‰ã‚’æŒ‡å®šã—ã¦ãã ã•ã„</div>'+
            '<div class="bt_help3">'+
            '<input class="trim_close" type="submit" value="âœ–">'+
            'TRIMæ“ä½œã®é¸æŠ'+
            '<input id="trim_add" type="submit" value="è¿½åŠ ">'+
            '<input id="trim_rem" type="submit" value="å‰Šé™¤">ã€€â¡ã€€'+
            '<input id="trim_do" type="submit" value="å®Ÿè¡Œ">'+
            '<input id="trim_cancel" type="submit" value="ä¸­æ­¢">'+
            'èµ¤ãƒ©ã‚¤ãƒ³ã®ä½ç½®ã«TRIMå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™</div>'+

            '<div class="bc_help4">'+
            '<input id="col_close" type="submit" value="âœ–">'+
            'è¡¨å¹…'+
            '<div class="wpx wpxw lock">'+
            '<input id="table_width" type="number"></div>'+
            'åˆ—å¹…æŒ‡å®š'+
            '<div class="wpx wpxw">'+
            '<input id="col_width" type="number" min="0" max="1000"></div>'+
            'åˆ—é¸æŠ'+
            '<input id="col_l" type="submit" value="â‡¦">'+
            '<input id="col_r" type="submit" value="â‡¨">'+
            '<span class="w_reset">ç­‰å¹…æŒ‡å®š</span>'+
            '<input id="specified" type="button" value="ã€€">'+
            '<span class="w_reset">è‹±æ–‡ç¦å‰‡</span>'+
            '<input id="word_b" type="button" value="No">'+
            '<span class="w_reset">åˆæœŸåŒ–</span>'+
            '<input id="to_auto" type="button" value="Auto">'+
            '</div></div>'+

            '<style>'+
            '#t_panel { position: fixed; top: 15px; left: calc(50% - 490px); width: 954px; '+
            'font-size: 14px; padding: 6px 12px; overflow: hidden; '+
            'border: 1px solid #ccc; border-radius: 4px; background: #eff5f6; z-index: 10; }'+
            '#t_panel * { user-select: none; }'+
            '#t_panel input { position: relative; margin-right: 10px; padding-top: 2px; '+
            'height: 27px; box-sizing: border-box; border: thin solid #aaa; }'+
            '#t_panel input[type="number"] { padding-right: 2px; margin-right: 0; }'+
            '#t_panel input[type="number"]:focus, #t_panel input[type="submit"]:focus '+
            '{ box-shadow: none; }'+
            '.t_label { margin: 0 3px 0 0; }'+

            '#col, #row { width: 40px; text-align: center; }'+
            '#wide { width: 30px; letter-spacing: -0.5em; text-indent: -6px; }'+
            '#t_width { width: 54px; text-align: center; }'+
            '#t_width_m { margin-left: -9px; width: 14px; }'+
            '#td_padd { width: 30px; margin-left: 2px; }'+
            '#equal { width: 34px; }'+
            '#border_width { width: 40px; text-align: center; }'+
            '#left_back_f { margin-left: -9px; width: 14px; text-indent: -1px; }'+
            '#t_font { width: 40px; text-align: center; }'+
            '#wide, #t_width_m, #td_padd, #equal, #left_back_f { background: #fff; }'+

            '.wnc, .wnr, .wpx, .wpxt { position: relative; display: inline-block; }'+
            '.wnc { margin-right: 2px; }'+
            '.wnr, .wpx, .wpxt { margin-right: 10px; }'+
            '.wnc::after { content: "åˆ—"; }'+
            '.wnr::after { content: "è¡Œ"; }'+
            '.wpx::after, .wpxt::after { content: "px"; }'+
            '.wnc::after, .wnr::after, .wpx::after, .wpxt::after { position: absolute; right: 2px; '+
            'top: 2px; padding: 3px 0 0; width: 17px; background: #fff; }'+
            '.wpx:hover::after, .wpxt:hover::after, .wnc:hover::after, .wnr:hover::after '+
            '{ content: ""; }'+
            '.wpxt.lock { pointer-events: none; background: #80deea; }'+
            '.wpxt.lock::after { background: inherit; }'+
            '.wpxt.lock #t_width { background: inherit; }'+
            '#t_width_m.lock { pointer-events: none; background: #80deea !important; }'+

            '#border_color { margin-left: -9px; }'+
            '#border_color, #header_back, #left_back, #cell_back { '+
            'width: 0; padding: 2px 16px 0 0; cursor: pointer; }'+
            '#border_color:focus, #header_back:focus, #left_back:focus, #cell_back:focus { '+
            'width: 99px; margin-right: -71px; padding: 2px 0 0 22px; z-index: 1; cursor: text; }'+

            '#copy { margin: 0 !important; padding: 2px 4px 0; font-weight: bold; '+
            'color: #fff; background: #1976d2; visibility: hidden; }'+
            '#set { margin: 0 !important; padding: 2px 4px 0; float: right; }'+
            '#set:hover, #copy:hover { background: #fff; color: #000; }'+
            '#set { background: #1976d2; color: #fff; }'+

            '#first { position: absolute; top: 0; left: 0; color: #fff; background: #2196f3; '+
            'width: 100%; padding: 10px 0; font-size: 16px; text-align: center; }'+
            '#bt_help { position: absolute; top: 11px; right: 25px; padding: 2px 1px 0; '+
            'line-height: 16px; font-weight: bold; border-radius: 30px; '+
            'color: #2196f3; background: #fff; cursor: pointer; }'+
            '.bt_help1 { text-align: left; margin-left: 60px; }'+
            '.bt_help2 { text-align: left; margin-left: 50px; }'+
            '.bt_help3 { text-align: left; margin: -3px 20px; }'+
            '.bt_help3 input { font: normal 15px/15px Meiryo; height: 26px !important; '+
            'padding: 2px 6px 0; color: #333; text-shadow: 0.5px 0 0.6px #666; '+
            'border: none !important; border-radius: 3px; }'+
            '.trim_close { margin-right: 30px !important; }'+
            '#trim_add { margin-left: 15px; }'+
            '#trim_cancel { margin-right: 30px !important; }'+

            '.bc_help4 { text-align: left; margin: -4px 20px; }'+
            '.bc_help4 input { color: #000; background: #fff; border-radius: 3px; }'+
            '.bc_help4 #col_close { margin-right: 30px !important; }'+
            '.bc_help4 #specified { width: 18px; height: 18px; vertical-align: -6px; '+
            'border: 2px solid #fff; background: #fff; }'+
            '.bc_help4 .wpx.wpxw { margin: 0 30px 0 10px; color: #000; }'+
            '.bc_help4 .wpxw::after { right: 6px; padding-top: 1px; width: 20px; }'+
            '.bc_help4 .wpxw.lock { pointer-events: none; }'+
            '.bc_help4 #table_width, .bc_help4 #col_width { padding: 3px 6px 0 !important; '+
            'margin: 0; width: 72px; height: 27px; text-align: center; border: none; }'+
            '.bc_help4 #col_close, .bc_help4 #col_l, .bc_help4 #col_r, .bc_help4 #to_auto, '+
            '.bc_help4 #word_b { '+
            'padding: 2px 6px 0; margin-right: 12px; height: 26px; border: none; }'+
            '.bc_help4 #col_l { margin-left: 10px; }'+
            '.bc_help4 .w_reset { margin: 0 6px 0 20px; }'+
            '.bc_help4 #word_b { width: 40px; }'+

            '#test { display: none; }'+
            '#cke_42 { top: 60px !important; left: calc( 50% - 45px) !important; }';

        if(ua==1){
            panel +=
                '.wpx::after, .wpxt::after { padding: 3px 1px 0; }'+
                '.wnc::after { padding: 3px 1px 0; }'+
                '.wnr::after { padding: 3px 1px 0; }'; }

        panel +=
            '</style>'+
            '</div>';

        if(!document.querySelector('#t_panel')){
            document.body.insertAdjacentHTML('beforeend', panel); }

    } // table_panel()



    function enhanced(){
        let target_r=document.getElementById('cke_1_contents'); // ç›£è¦– target
        let monitor_r=new MutationObserver(select);
        monitor_r.observe(target_r, {childList: true}); // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆå¾…å—ã‘é–‹å§‹

        select();

        function select(){
            if(document.querySelector('.cke_wysiwyg_frame') !=null){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ã‹ã‚‰å®Ÿè¡Œé–‹å§‹
                remove_mark_all(); // Htmlç·¨é›†å¾Œã®ãƒªã‚»ãƒƒãƒˆ
                show_first(1);
                let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
                let iframe_doc=editor_iframe.contentWindow.document;
                if(iframe_doc){
                    let style_if=
                        '<style id="style_if">'+
                        '.amb_active { box-shadow: #fff -4px 0px, #2196f3 -8px 0px !important; }'+
                        '.trimr_active { box-shadow: 0 -3px 0 red, inset 0 2px 0 red; }'+
                        '.trimd_active { box-shadow: -3px 0 red, inset 2px 0 0 red; }'+
                        '.trim_active { box-shadow: inset 0 0 0 50px rgba(255, 0, 0, 0.6); }'+
                        '.col_active { box-shadow: inset 0 4px 0 #2196f3; }'+
                        '</style>';

                    if(!iframe_doc.head.querySelector('#style_if')){
                        iframe_doc.head.insertAdjacentHTML('beforeend', style_if); }

                    let editor=iframe_doc.querySelector('.cke_editable');
                    if(editor){
                        editor.onclick=function(event){
                            event.stopImmediatePropagation();

                            if(event.ctrlKey){
                                remove_mark_all();
                                if(task==1 || task==2 || task==3 || task==4){
                                    let elm=iframe_doc.elementFromPoint(event.clientX, event.clientY);

                                    if(elm.closest('table')!=null){
                                        let table_id=elm.closest('table').id;
                                        if(table_id && table_id.includes('ambt')){
                                            if(iframe_doc.querySelector('.'+ table_id)){
                                                remove_mark();
                                                setTimeout(()=>{
                                                    alert(
                                                        " â›” è»½é‡ã‚¿ã‚¤ãƒ—ã®è¡¨ã¯ã€ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® ã€ŒBlog Tableã€"+
                                                        "ã§ã¯\nã€€ã€€æ›´æ–°ãŒã§ãã¾ã›ã‚“ã€‚\nã€€ã€€"+
                                                        "ã“ã®è¡¨ã‚’æ›´æ–°ã™ã‚‹ã«ã¯ ver.4.0 ä»¥é™ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚");
                                                },20 );}
                                            else{
                                                elm.closest('table').parentNode.classList.add('amb_active');
                                                show_first(0);
                                                task=3;
                                                edit_table(task, elm.closest('table')); }}} //ã€Œè¡¨æ›´æ–°ã€

                                    else{
                                        if(elm.tagName=='P' || elm.tagName=='DIV'){
                                            elm.classList.add('amb_active');
                                            show_first(0);
                                            task=2;
                                            edit_table(task, 0); }}}} //ã€Œè¡¨ä½œæˆã€

                            if(event.altKey){
                                remove_mark_all();
                                if(task==1 || task==2 || task==3 || task==4){
                                    let elm=iframe_doc.elementFromPoint(event.clientX, event.clientY);

                                    if(elm.closest('table')!=null){
                                        let selectTr;
                                        let selectTd;
                                        let Table=elm.closest('table');
                                        Table.parentNode.classList.add('amb_active');

                                        let Tr=elm.closest('tr');
                                        let allTR=Table.querySelectorAll('tr');
                                        for(let k=0; k<allTR.length; k++){
                                            if(Tr==allTR[k]){
                                                selectTr=k; } // é¸æŠã—ãŸè¡Œ
                                            let Td=elm.closest('td');
                                            let allTd=allTR[k].querySelectorAll('td');
                                            for(let k=0; k<allTd.length; k++){
                                                if(Td==allTd[k]){
                                                    selectTd=k; }}} // é¸æŠã—ãŸåˆ—

                                        if((selectTr>0 && selectTd==0) || (selectTr==0 && selectTd>0)){
                                            trim_table(Table, selectTr, selectTd); }
                                        else{
                                            remove_mark_trim();
                                            show_first(2); }}
                                    else{
                                        remove_mark_trim();
                                        show_first(2); }}} //ã€Œè¡¨æ›´æ–°ã€åˆ—ãƒ»è¡Œã®ä¿®æ­£

                        }}}}} // select()

    } // enhanced()



    function trim_table(trim_Table, R, D){
        show_first(3);
        trim_select();

        if(trim==0){
            if(D==0){ // è¡Œè¿½åŠ å‡¦ç†
                let allTr=trim_Table.querySelectorAll('tr');
                let allTd=allTr[R].querySelectorAll('td');
                for(let k=0; k<allTd.length; k++){
                    trim_color(0, 'r_mark', allTd[k]); }
                trim_action(trim_Table, 1, R, D); }

            if(R==0){ // åˆ—è¿½åŠ å‡¦ç†
                let allTr=trim_Table.querySelectorAll('tr');
                for(let k=0; k<allTr.length; k++){
                    let allTd=allTr[k].querySelectorAll('td');
                    trim_color(0, 'd_mark', allTd[D]); }
                trim_action(trim_Table, 2, R, D); }}

        if(trim==1){
            if(D==0){ // è¡Œå‰Šé™¤å‡¦ç†
                let allTr=trim_Table.querySelectorAll('tr');
                let allTd=allTr[R].querySelectorAll('td');
                for(let k=0; k<allTd.length; k++){
                    trim_color(1, 'r_mark', allTd[k]); }
                trim_action(trim_Table, 3, R, D); }

            if(R==0){ // åˆ—å‰Šé™¤å‡¦ç†
                let allTr=trim_Table.querySelectorAll('tr');
                for(let k=0; k<allTr.length; k++){
                    let allTd=allTr[k].querySelectorAll('td');
                    trim_color(1, 'd_mark', allTd[D]); }
                trim_action(trim_Table, 4, R, D); }}


        let trim_close=document.querySelector('.trim_close');
        if(trim_close){
            trim_close.onclick=function(){
                remove_mark_trim();
                edit_table(3, trim_Table);
                show_first(0); }}

    } // trim_table()



    function trim_select(){
        let trim_add=document.querySelector('#trim_add');
        let trim_rem=document.querySelector('#trim_rem');
        if(trim_add && trim_rem){
            trim_set();

            trim_add.onclick=function(){
                if(trim==1){
                    trim=0;
                    trim_set(); }}

            trim_rem.onclick=function(){
                if(trim==0){
                    trim=1;
                    trim_set(); }}

            function trim_set(){
                remove_mark_trim();
                if(trim==0){
                    trim_add.style.background='#fff';
                    trim_rem.style.background='#95c3e8'; }
                else{
                    trim_add.style.background='#95c3e8';
                    trim_rem.style.background='#fff'; }}}

    } // trim_select()



    function trim_color(n, mark, cell){
        if(n==0){
            if(mark=='r_mark'){ // è¡Œè¿½åŠ ã®è¡¨ç¤º
                cell.classList.add('trimr_active'); }
            if(mark=='d_mark'){ // åˆ—è¿½åŠ ã®è¡¨ç¤º
                cell.classList.add('trimd_active'); }}
        if(n==1){ // å‰Šé™¤ã®è¡¨ç¤º
            cell.classList.add('trim_active'); }}



    function trim_action(trim_Table, type, R, D){
        let trim_do=document.querySelector('#trim_do');
        let trim_cancel=document.querySelector('#trim_cancel');

        trim_do.onclick=function(){
            if(type==1){
                add_tr(trim_Table, R); }
            if(type==2){
                add_td(trim_Table, D); }
            if(type==3){
                rem_tr(trim_Table, R); }
            if(type==4){
                rem_td(trim_Table, D); }

            if(layout_fix=='fixed'){
                let t_width=document.querySelector('#t_width'); // è¡¨å…¨å¹…ã®è¨­å®š
                trim_Table.style.width=''; // è¡¨å¹…ãƒªã‚»ãƒƒãƒˆ
                let t_width_g=getComputedStyle(trim_Table).width;
                if(t_width_g){
                    t_width.value=Math.ceil((t_width_g.replace('px', ''))); } // åˆ‡ã‚Šä¸Šã’
                else{
                    t_width.value=580; }
                trim_Table.style.width= t_width.value+'px'; }

            edit_table(3, trim_Table);
            show_first(0); }


        trim_cancel.onclick=function(){
            remove_mark_trim();
            edit_table(3, trim_Table);
            show_first(0); }


        function add_tr(trim_Table, R){
            let allTr=trim_Table.querySelectorAll('tr');
            let clone_tr=allTr[R].cloneNode(true);
            let allTd=clone_tr.querySelectorAll('td');
            for(let k=0; k<allTd.length; k++){
                allTd[k].textContent=''; }
            allTr[R].parentNode.insertBefore(clone_tr, allTr[R]);
            remove_mark_trim(); }


        function add_td(trim_Table, D){
            let allTr=trim_Table.querySelectorAll('tr');
            for(let k=0; k<allTr.length; k++){
                let refer_td=allTr[k].querySelectorAll('td')[D]
                let clone_td=refer_td.cloneNode(true);
                clone_td.textContent='';
                allTr[k].insertBefore(clone_td, refer_td); }
            remove_mark_trim(); }


        function rem_tr(trim_Table, R){
            let allTr=trim_Table.querySelectorAll('tr');
            allTr[R].remove(); }


        function rem_td(trim_Table, D){
            let allTr=trim_Table.querySelectorAll('tr');
            for(let k=0; k<allTr.length; k++){
                allTr[k].querySelectorAll('td')[D].remove(); }}

    } // trim_action()



    function pick_color(){
        let set_color;
        let color_input_selector;
        let color_label;
        let icon_button;

        if(ua==0){
            color_label=document.querySelector('#cke_16_label');
            icon_button=document.querySelector('#cke_17'); }
        else if(ua==1){
            color_label=document.querySelector('#cke_15_label');
            icon_button=document.querySelector('#cke_16'); }

        let target_p=color_label; // ç›£è¦– ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚«ãƒ©ãƒ¼ãƒ©ãƒ™ãƒ«
        let monitor_p=new MutationObserver(get_copy);

        color_input=document.querySelectorAll('#t_panel input[type="text"]');
        for(let k=0; k<color_input.length; k++){
            input_color(k); }



        function input_color(k){
            let trust_color;

            color_input[k].onmousedown=function(event){ // ğŸŸ¡
                if(event.ctrlKey==true){
                    event.preventDefault();
                    event.stopImmediatePropagation(); // ğŸŸ¡
                    for(let i=0; i<color_input.length; i++){ // ä»–ã®inputã®è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
                        color_input[i].style.outline=''; }
                    color_input_selector=k;
                    color_input[k].style.outline='2px solid #2196f3'; // å¯¾è±¡ã‚«ãƒ©ãƒ¼inputã‚’è¡¨ç¤º
                    icon_button.click();
                    monitor_p.observe(target_p, {attributes: true}); }
                else if(event.shiftKey==true){
                    event.preventDefault();
                    color_input_selector=k;
                    if(test_colorE(hex_bright(color_input[k].value))){
                        color_input[k].value=hex_bright(color_input[k].value); // æ˜åº¦ã‚’ä¸Šã’ã‚‹
                        sticky_color(color_input[k]); }}

            } // ã‚¢ã‚¤ã‚³ãƒ³ã‚«ãƒ©ãƒ¼å–å¾—é–‹å§‹



            color_input[k].addEventListener('change', function(event){
                event.preventDefault();
                if(test_colorE(color_input[k].value)){
                    color_input[k].value=hex_8_6(trust_color);
                    sticky_color(color_input[k]); }
                else{
                    if(color_input[k].value==''){
                        color_input[k].style.boxShadow='inset 0 0 0 1px black'; }
                    else{
                        color_input[k].style.boxShadow='inset 0 0 0 1px black'; // æ‹…ä¿ã‚³ãƒ¼ãƒ‰
                        color_input[k].style.boxShadow=
                            'inset 0 0 0 1px black, inset 17px 0 ' + color_input[k].value+
                            ', inset 18px 0 #aaa'; }}});



            function test_colorE(color){
                let test=document.querySelector('#test');
                test.style.color='#000001';
                if(color!=''){
                    test.style.color=color; } // å…¥åŠ›æ ãŒç©ºã®å ´åˆã¯NGåˆ¤å®š
                let colorR=window.getComputedStyle(test).color;
                if(colorR){
                    trust_color=rgb_hex(colorR); // é©æ­£å€¤ã‚’6æ¡16é€²ã§è¿”ã™

                    if(colorR!='rgb(0, 0, 1)'){
                        return true; } // æ­£å¸¸ãªè‰²
                    else{
                        if(color=='rgb(0, 0, 1)' || color=='#000001' || color=='#000001ff'){
                            return true; } //ã€Œ#000001ã€ã‚’ãƒ†ã‚¹ãƒˆã—ãŸå ´åˆã¯ ä¾‹å¤–å‡¦ç†
                        else{
                            return false; }}}
                else{
                    return false; }}

        } // input_color()



        document.addEventListener('mousedown', function(){ // ğŸŸ¡
            if(color_input[color_input_selector]){
                color_input[color_input_selector].style.outline='none'; }
            monitor_p.disconnect(); }); // ã‚«ãƒ©ãƒ¼å–å¾—çµ‚äº†



        if(document.querySelector('.cke_wysiwyg_frame') !=null){
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            let iframe_doc=editor_iframe.contentWindow.document;
            iframe_doc.addEventListener('mousedown', function(){ // ğŸŸ¡
                if(color_input[color_input_selector]){
                    color_input[color_input_selector].style.outline='none'; }
                monitor_p.disconnect(); }); } // ã‚«ãƒ©ãƒ¼å–å¾—çµ‚äº†



        function get_copy(){
            set_color=color_label.getAttribute('data-color');
            color_input[color_input_selector].value='#'+ set_color;
            sticky_color(color_input[color_input_selector]);
            color_input[color_input_selector].style.outline='none';

            monitor_p.disconnect(); } // ã‚«ãƒ©ãƒ¼å–å¾—çµ‚äº†



        let target_body=document.querySelector('.l-body'); // ç›£è¦– target
        let monitor_generator=new MutationObserver(stealth);
        monitor_generator.observe(target_body, {childList: true, subtree: true});

        function stealth(){
            let color_generator=document.querySelector('.ck-l-colorGenerator');
            if(color_generator){
                color_generator.addEventListener('mousedown', function(event){ // ğŸŸ¡
                    event.stopImmediatePropagation(); }); }}

    } // pick_color()



    function table_position_set(){
        let wide=document.querySelector('#wide'); // ä¸­å¤®é…ç½®ãƒ»å·¦å¯„ã›ã®è¨­å®š
        if(posit_set==0){
            wide.value='ã€€â–¢ã€€';
            table_position='0 auto'; }
        else if(posit_set==1){
            wide.value='â–¢ã€€ã€€';
            table_position='0 auto 0 0'; }

        wide.onclick=function(event){
            event.preventDefault();
            if(posit_set==0){
                posit_set=1;
                wide.value='â–¢ã€€ã€€';
                table_position='0 auto 0 0'; }
            else if(posit_set==1){
                posit_set=0;
                wide.value='ã€€â–¢ã€€';
                table_position='0 auto'; }}}



    function t_width_lock(r_table){
        let count=0;
        let top_td=r_table.querySelectorAll('tr:first-child td');
        for(let k=0; k<top_td.length; k++){
            if(top_td[k].style.width){
                count+=1; }}
        if(count>0){
            table_lock(1); }
        else{
            table_lock(0); }}


    function table_lock(n){
        let wpxt=document.querySelector('.wpxt'); // è¡¨å¹…
        let t_width_m=document.querySelector('#t_width_m'); // MEMO
        if(n==0){
            wpxt.classList.remove('lock');
            t_width_m.classList.remove('lock'); }
        else{
            wpxt.classList.add('lock');
            t_width_m.classList.add('lock'); }}



    function table_width_memo(){
        let t_width=document.querySelector('#t_width'); // è¡¨å…¨å¹…ã®è¨­å®š
        let t_width_m=document.querySelector('#t_width_m'); // è¡¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¹…ã®ç™»éŒ²
        t_width_m.onclick=function(event){
            if(event.ctrlKey==false){
                event.preventDefault();
                t_width.value=setting[5]; // MEMOå€¤ã‚’å‘¼å‡ºã—ã¦è¨­å®š
                t_width_m.style.background='#00afff';
                setTimeout(()=>{
                    t_width_m.style.background='#fff';
                    t_width_m.style.transition='1s'; }, 2000);
                setTimeout(()=>{
                    t_width_m.style.transition='0s'; }, 3000); }

            else if(event.ctrlKey==true){
                let yes=window.confirm("ã€€ğŸ”µ ç¾åœ¨ã®ã€Œè¡¨å¹…ã€ã‚’ã€ŒMEMOå€¤ã€ã«ç™»éŒ²ã—ã¾ã™");
                if(yes){
                    setting[5]=t_width.value;
                    write_locals(setting); }}}} // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜



    function td_padding_set(){
        let td_padd=document.querySelector('#td_padd'); // tdã®æ¨ªpadding æœ‰ç„¡ã®è¨­å®š
        if(add_padd==0){
            td_padd.value='p0';
            td_padd.style.boxShadow='none'; }
        else{
            td_padd.value='p+';
            td_padd.style.boxShadow='inset 6px 0 0 #cefed0, inset -6px 0 0 #cefed0'; }

        td_padd.onclick=function(event){
            event.preventDefault();
            if(add_padd==0){
                add_padd=0.6;
                td_padd.value='p+';
                td_padd.style.boxShadow='inset 6px 0 0 #cefed0, inset -6px 0 0 #cefed0'; }
            else{
                add_padd=0;
                td_padd.value='p0';
                td_padd.style.boxShadow='none'; }}}



    function lafix_set(task, r_table){
        let equal=document.querySelector('#equal'); // table-layout ã®è¨­å®š
        if(layout_fix=='fixed'){
            equal.value='Fix';
            equal.style.background='#80deea'; }
        else{
            layout_fix='auto';
            equal.value='Auto';
            equal.style.background='#fff'; }

        equal.onclick=function(event){
            event.preventDefault();
            if(event.ctrlKey){
                if(task==3){
                    reset_width(r_table, 0); }}
            else{
                if(task==3){
                    task=4;
                    manu_width(r_table); }
                else{
                    if(layout_fix=='auto'){
                        layout_fix='fixed';
                        equal.value='Fix';
                        equal.style.background='#80deea'; }
                    else{
                        layout_fix='auto';
                        equal.value='Auto';
                        equal.style.background='#fff'; }}}}}


    function manu_width(r_table){
        let bc_help4=document.querySelector('.bc_help4');
        let col_close=document.querySelector('#col_close');
        let table_width=document.querySelector('#table_width');
        let col_width=document.querySelector('#col_width');
        let col_l=document.querySelector('#col_l');
        let col_r=document.querySelector('#col_r');
        let specified=document.querySelector('#specified');
        let word_b=document.querySelector('#word_b');
        let to_auto=document.querySelector('#to_auto');

        show_first(4);
        spec_disp(1);

        let top_td=r_table.querySelectorAll('tr:first-child td');
        set_fix();
        layout_fix='fixed';
        r_table.style.tableLayout='fixed';

        if(!top_td[cell_set]){
            cell_set=0; }

        top_td[cell_set].classList.add('col_active');
        col_w_set(top_td[cell_set]);


        col_l.onclick=function(){
            top_td[cell_set].classList.remove('col_active');
            if(cell_set==0){
                cell_set=top_td.length -1; }
            else{
                cell_set -=1; }
            top_td[cell_set].classList.add('col_active');
            col_w_set(top_td[cell_set]); }

        col_r.onclick=function(){
            top_td[cell_set].classList.remove('col_active');
            if(cell_set==top_td.length -1){
                cell_set=0; }
            else{
                cell_set +=1; }
            top_td[cell_set].classList.add('col_active');
            col_w_set(top_td[cell_set]); }


        function col_w_set(col){
            let col_w=getComputedStyle(col).width;
            col_width.value=parseInt((col_w.replace('px', '')), 10);

            col_width.oninput=function(){
                col.style.width=col_width.value + 'px';
                set_fix(); }

            specified.onclick=function(){
                all_set(0);
                spec_disp(0);
                setTimeout(()=>{
                    all_set(1);
                    let col_w=getComputedStyle(col).width;
                    col_width.value=parseInt((col_w.replace('px', '')), 10);
                }, 200);
                setTimeout(()=>{
                    spec_disp(1);
                }, 600); }}


        if(word_break=='break-all'){
            word_b.value='No'; }
        else if(word_break=='break-word'){
            word_b.value='Yes'; }
        else{
            word_b.value='---'; }
        r_table.style.wordBreak=word_break;

        word_b.onclick=function(){
            if(word_b.value=='No'){
                word_break='break-word';
                word_b.value='Yes'; }
            else if(word_b.value=='Yes'){
                word_break='unset';
                word_b.value='---'; }
            else{
                word_break='break-all';
                word_b.value='No'; }
            r_table.style.wordBreak=word_break;
            set_fix(); }


        to_auto.onclick=function(){
            reset_width(r_table, 1); }


        function set_fix(){
            all_set(1);
            r_table.style.width='';

            let r_table_width=getComputedStyle(r_table).width;
            if(r_table_width){
                table_width.value=Math.ceil((r_table_width.replace('px', ''))); } // åˆ‡ã‚Šä¸Šã’
            else{
                table_width.value=580; }
            r_table.style.width=table_width.value+'px'; }


        function all_set(n){
            for(let k=0; k<top_td.length; k++){
                if(n==0){
                    if(top_td[k].style.width){
                        top_td[k].style.width=''; }}
                else{
                    let set_w=getComputedStyle(top_td[k]).width;
                    if(set_w && !top_td[k].style.width){
                        top_td[k].style.width=set_w; }}}}


        function spec_disp(n){
            if(n==0){
                specified.style.background='#fff'; }
            else{
                specified.style.background='#29b6f6'; }}


        col_close.onclick=function(){
            task=3;
            remove_mark_col();
            show_first(0);
            edit_table(3, r_table); }

    } // manu_width()



    function reset_width(r_table, n){
        if(layout_fix=='fixed'){
            let yes=window.confirm(
                "ã€€ğŸ”´ã€€è¡¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’ã€ŒFixã€ã‹ã‚‰ã€ŒAutoã€ã«å¤‰æ›´ã—ã¾ã™ã€‚\n"+
                "ã€€ã€€ã€€ ç¾åœ¨ã®è¡¨å¹…ã®ã¾ã¾ã§ã€åˆ—å¹…ã®èª¿æ•´ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚\n"+
                "ã€€ã€€ã€€ã€ŒOKã€ã‚’æŠ¼ã™ã¨ã€åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚");
            if(yes){
                let equal=document.querySelector('#equal'); // table-layout ã®è¨­å®š
                layout_fix='auto';
                r_table.style.tableLayout='auto';
                equal.value='Auto';
                equal.style.background='#fff';

                let top_td=r_table.querySelectorAll('tr:first-child td');
                for(let k=0; k<top_td.length; k++){
                    if(top_td[k].style.width){
                        top_td[k].style.width=''; }}

                t_width_lock(r_table);

                if(n==1){ // ã‚»ãƒ«å¹…ã®è¨­å®šãƒ‘ãƒãƒ«ã®å ´åˆ
                    task=3;
                    remove_mark_col();
                    show_first(0);
                    edit_table(3, r_table); }
            }}}



    function table_border_set(){
        let border_width=document.querySelector('#border_width'); // æ ç·šå¹…ã®è¨­å®š
        two_way();

        border_width.addEventListener('input', function(event){
            event.preventDefault();
            two_way(); });

        function two_way(){
            if(border_width.value>-1){
                border_collapse='collapse';
                table_border_width='0';
                cell_border_width=border_width.value;
                border_space=0; }
            else if(border_width.value<0){
                border_collapse='separate';
                table_border_width='1';
                cell_border_width=1;
                border_space=border_width.value*(-1); }}}



    function left_full_set(){
        let left_back_full=document.querySelector('#left_back_f'); // å·¦ç«¯è‰²ã‚’æœ€ä¸Šè¡Œã¾ã§è¨­å®š
        if(left_full==' tr:not(:first-child)'){
            left_back_full.style.color='#aaa';
            left_back_full.style.boxShadow='none'; }
        else{
            left_back_full.style.color='red';
            left_back_full.style.boxShadow='inset 0 5px red'; }

        left_back_full.onclick=function(event){
            event.preventDefault();
            if(left_full==' tr:not(:first-child)'){
                left_full=' tr';
                left_back_full.style.color='red';
                left_back_full.style.boxShadow='inset 0 5px red'; }
            else{
                left_full=' tr:not(:first-child)';
                left_back_full.style.color='#aaa';
                left_back_full.style.boxShadow='none'; }}}



    function show_color(){
        color_input=document.querySelectorAll('#t_panel input[type="text"]');
        for(let k=0; k<color_input.length; k++){
            color_input[k].value=setting[k+9];
            sticky_color(color_input[k]); }}


    function sticky_color(box){
        box.style.boxShadow='inset 17px 0 '+ box.value +', inset 18px 0 #aaa'; }



    function edit_table(task, r_table){
        let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
        let iframe_doc=editor_iframe.contentWindow.document;

        let this_col; // æ›´æ–°å‰ã®åˆ—æ•°
        let this_row; // æ›´æ–°å‰ã®è¡Œæ•°
        let col=document.querySelector('#col'); // åˆ—æ•°ã®è¨­å®š
        let row=document.querySelector('#row'); // è¡Œæ•°ã®è¨­å®š
        let t_width=document.querySelector('#t_width'); // è¡¨å…¨å¹…ã®è¨­å®š
        let border_width=document.querySelector('#border_width'); // æ ç·šå¹…ã®è¨­å®š
        let border_color=document.querySelector('#border_color'); // æ ç·šè‰²ã®è¨­å®š
        let header_back=document.querySelector('#header_back'); // æœ€ä¸Šè¡ŒèƒŒæ™¯è‰²ã®è¨­å®š
        let left_back=document.querySelector('#left_back'); // å·¦ç«¯è¡ŒèƒŒæ™¯è‰²ã®è¨­å®š
        let cell_back=document.querySelector('#cell_back'); // å…¨ä½“èƒŒæ™¯è‰²ã®è¨­å®š
        let t_font=document.querySelector('#t_font'); // æ–‡å­—ã‚µã‚¤ã‚ºã®è¨­å®š
        let copy=document.querySelector('#copy'); // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
        let set=document.querySelector('#set'); // ä½œæˆãƒœã‚¿ãƒ³


        if(task==2){
            set.value='è¡¨ä½œæˆ';
            copy.style.visibility='hidden';
            table_lock(0);
            table_create(); }
        else if(task==3){
            set.value='è¡¨æ›´æ–°';
            copy.style.visibility='visible';
            copy_table();
            table_renew(r_table); }



        function table_create(){
            setting=read_locals();

            col.value=setting[1];
            row.value=setting[2];
            posit_set=setting[3];
            table_position_set();
            t_width.value=setting[4];
            table_width_memo();
            add_padd=setting[6];
            td_padding_set();
            layout_fix=setting[14];
            lafix_set(2, 0);
            border_width.value=setting[7];
            table_border_set();
            left_full=setting[8];
            left_full_set();
            show_color(); // inputã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å€¤ã‚’ã‚»ãƒƒãƒˆ [9][10][11][12]
            pick_color();
            t_font.value=setting[13];
            word_break=setting[15];



            set.onclick=function(event){
                if(task==2){
                    let n_table=iframe_doc.createElement("table");
                    let rows=[];
                    for(let i=0; i<row.value; i++){
                        rows.push(n_table.insertRow(-1)); // è¡Œã®è¿½åŠ 
                        for(let j=0; j<col.value; j++){
                            let cell=rows[i].insertCell(-1);
                            cell.appendChild(iframe_doc.createTextNode('')); }} // åˆ—ã®è¿½åŠ 

                    let table_id=new_table_id();
                    n_table.setAttribute('id', table_id);
                    n_table.setAttribute('style', set_css());

                    let scroll_container=iframe_doc.createElement('div');
                    scroll_container.setAttribute('style', 'overflow-x: auto');

                    let selection=iframe_doc.getSelection();
                    let range=selection.getRangeAt(0);
                    let ac_node=selection.anchorNode;

                    ac_node.parentNode.insertBefore(scroll_container, ac_node);
                    scroll_container.appendChild(n_table);

                    let cn_table=iframe_doc.querySelector('#'+ table_id);

                    let first_tr=cn_table.querySelectorAll('tr')[0];
                    if(first_tr){
                        first_tr.style.backgroundColor=header_back.value; }

                    let left_td=cn_table.querySelectorAll(left_full +' td:first-child');
                    for(let k=0; k<left_td.length; k++){
                        left_td[k].style.backgroundColor=left_back.value; }

                    let all_td=cn_table.querySelectorAll('td');
                    for(let k=0; k<all_td.length; k++){
                        all_td[k].style.border=cell_border_width +'px solid '+ border_color.value;
                        all_td[k].style.padding='0.2em '+ add_padd +'em 0';
                        all_td[k].style.height='1.5em'; }


                    task=3;
                    remove_mark(); // é¸æŠè¡¨ç¤ºã‚’æ•´å½¢
                    show_first(0);
                    cn_table.parentNode.classList.add('amb_active');
                    edit_table(3, cn_table)

                }} // set.onclick

        } // table_create



        function table_renew(r_table){
            pick_color();
            table_width_memo();
            t_width_lock(r_table);

            let t_tr=r_table.querySelectorAll('tr');
            row.value=t_tr.length;

            let t_td=r_table.querySelectorAll('td');
            col.value=t_td.length / t_tr.length;

            let margin_g=r_table.style.margin;
            if(margin_g && margin_g.includes('0px auto 0px 0px')){
                posit_set=1; }
            else {
                posit_set=0; }
            table_position_set();

            let t_width_g=r_table.style.width;
            if(t_width_g){
                t_width.value=t_width_g.replace(/[^0-9]/g, ''); }
            else{
                t_width.value=580; }

            let add_padd_g=t_td[t_td.length-1].style.paddingLeft;
            if(add_padd_g){
                add_padd=add_padd_g.slice(0, -2); } // è¡¨æœ«å°¾ã®ã€Œtdã€ã® padding
            else{
                add_padd=0; }
            td_padding_set();

            if(r_table.style.tableLayout=='fixed'){
                layout_fix='fixed'; }
            else{
                layout_fix='auto'; }
            lafix_set(3, r_table);

            let t_border_width_g=t_td[t_td.length-1].style.borderWidth;
            let t_border_width;
            if(t_border_width_g){
                t_border_width=t_border_width_g.replace(/[^0-9]/g, ''); } // è¡¨æœ«å°¾ã®ã€Œtdã€ã® border
            else{
                t_border_width=1; }
            let border_space_g=r_table.style.borderSpacing;
            if(border_space_g){
                border_space=border_space_g.replace(/[^0-9]/g, ''); }
            else{
                border_space=0; }
            if(border_space!=0){
                border_width.value=border_space*(-1); }
            if(border_space==0){
                border_width.value=t_border_width; }
            table_border_set();

            if(t_td[0].style.backgroundColor==''){ // è¡¨å…ˆé ­ã€Œtdã€ã®èƒŒæ™¯è‰²æŒ‡å®šã®æœ‰ç„¡
                left_full=' tr:not(:first-child)'; }
            else{
                left_full=' tr'; }
            left_full_set();

            let t_border_color=t_td[t_td.length-1].style.borderColor; // è¡¨æœ«å°¾ã®ã€Œtdã€ã® borderè‰²
            if(t_border_color==''){
                t_border_color='#999'; }
            border_color.value=rgb_hex(t_border_color);
            sticky_color(border_color);

            let t_header_back=t_tr[0].style.backgroundColor; // æœ€åˆã®ã€Œtrã€ã®èƒŒæ™¯è‰²
            if(t_header_back==''){
                t_header_back='#F4F4F4'; }
            header_back.value=rgb_hex(t_header_back);
            sticky_color(header_back);

            let t_left_back;
            if(t_tr.length>1){
                t_left_back=t_td[t_td.length / t_tr.length].style.backgroundColor; // å·¦ç«¯åˆ— èƒŒæ™¯è‰² 1
                if(t_left_back==''){
                    t_left_back='#F4F4F4'; }}
            else{
                t_left_back=t_td[0].style.backgroundColor; // å·¦ç«¯åˆ— èƒŒæ™¯è‰² 2
                if(t_left_back==''){
                    t_left_back='#F4F4F4'; }}
            left_back.value=rgb_hex(t_left_back);
            sticky_color(left_back);

            let t_cell_back=r_table.style.backgroundColor; // è¡¨ã€Œr_tableã€ã® èƒŒæ™¯è‰²
            if(t_cell_back==''){
                t_cell_back='#FFF';}
            cell_back.value=rgb_hex(t_cell_back);
            sticky_color(cell_back);

            let t_font_size=r_table.style.fontSize;
            if(t_font_size==''){
                t_font.value='16'; }
            else{
                t_font.value=t_font_size.replace(/[^0-9]/g, ''); }

            let t_word_break=r_table.style.wordBreak; // è¡¨ã€Œr_tableã€ã® word-breakè¨­å®š
            if(t_word_break=='break-all' || t_word_break=='break-word'){
                word_break=t_word_break; }
            else{
                word_break='unset'; }



            set.onclick=function(){
                if(task==3){
                    let t_tr=r_table.querySelectorAll('tr');
                    this_row=t_tr.length;
                    let t_td=r_table.querySelectorAll('td');
                    this_col=t_td.length / t_tr.length;
                    let insert=[];

                    let com_ok=0; // è¡Œåˆ—ã®å‰Šé™¤è¨±å¯
                    if(row.value<this_row||col.value<this_col){
                        com_ok=1;
                        let ok=confirm(
                            "ã€€ğŸ”´ã€€è¡Œæ•°ã¾ãŸã¯åˆ—æ•°ã‚’æ¸›ã‚‰ã™è¡¨æ›´æ–°ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚\n"+
                            "ã€€ã€€ ã€€è¡Œã‚„åˆ—ã®å‰Šé™¤ã§ã€ä¸­ã«è¨˜å…¥ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\n"+
                            "ã€€ã€€ ã€€ã“ã®å‰Šé™¤ã‚’è¡Œã£ã¦ã‚‚ã‚ˆã„ã§ã™ã‹ï¼Ÿ");
                        if(ok){
                            com_ok=0; }
                        else{ ; }}

                    if(row.value>this_row){
                        for(let i=this_row; i<row.value; i++){
                            insert[i]=r_table.insertRow(-1); // è¡Œã®è¿½åŠ 
                            for(let j=0; j<this_col; j++){
                                let cell=insert[i].insertCell(-1);
                                cell.appendChild(document.createTextNode('')); }}}
                    else if(row.value<this_row){
                        if(com_ok==0){
                            for(let i=this_row; i>row.value; i--){
                                insert[i]=r_table.deleteRow(-1); }}} // è¡Œã®å‰Šé™¤

                    insert=r_table.querySelectorAll('tr');
                    for(let i=0; i<insert.length; i++){
                        if(col.value>this_col){
                            for(let j=this_col; j<col.value; j++){
                                let cell=insert[i].insertCell(-1);
                                cell.appendChild(document.createTextNode('')); }} // åˆ—ã®è¿½åŠ 
                        else if(col.value<this_col){
                            if(com_ok==0){
                                for(let j=this_col; j>col.value; j--){
                                    let cell=insert[i].deleteCell(-1); }}}} // åˆ—ã®å‰Šé™¤


                    r_table.setAttribute('style', set_css());

                    let first_tr=r_table.querySelectorAll('tr')[0];
                    if(first_tr){
                        first_tr.style.backgroundColor=header_back.value; }

                    let top_td=r_table.querySelectorAll('td')[0];
                    top_td.style.backgroundColor=''; // ã‚³ãƒ¼ãƒŠãƒ¼ã®ã€Œtdã€ã®èƒŒæ™¯ã‚’ãƒªã‚»ãƒƒãƒˆ
                    let left_td=r_table.querySelectorAll(left_full +' td:first-child');
                    for(let k=0; k<left_td.length; k++){
                        left_td[k].style.backgroundColor=left_back.value; }

                    let all_td=r_table.querySelectorAll('td');
                    for(let k=0; k<all_td.length; k++){
                        all_td[k].style.border=cell_border_width +'px solid '+ border_color.value;
                        all_td[k].style.padding='0.2em '+ add_padd +'em 0';
                        all_td[k].style.height='1.5em'; }


                    if(layout_fix=='fixed'){ //ã€ŒFixã€ãƒ¢ãƒ¼ãƒ‰æ™‚ã®tableå¹…é©æ­£åŒ–
                        let wpxt=document.querySelector('.wpxt'); // è¡¨å¹…
                        if(!wpxt.classList.contains('lock')){ //ã€ŒFixã€ãƒ¢ãƒ¼ãƒ‰ã§å¹…å¯å¤‰
                            let top_td=r_table.querySelectorAll('tr:first-child td');
                            for(let k=0; k<top_td.length; k++){
                                let set_w=getComputedStyle(top_td[k]).width;
                                if(set_w && !top_td[k].style.width){
                                    top_td[k].style.width=set_w; }}}

                        t_width_lock(r_table);

                        r_table.style.width=''; // è¡¨å¹…ãƒªã‚»ãƒƒãƒˆ
                        let t_width_g=getComputedStyle(r_table).width;
                        if(t_width_g){
                            t_width.value=Math.ceil((t_width_g.replace('px', ''))); } // åˆ‡ã‚Šä¸Šã’
                        else{
                            t_width.value=580; }
                        r_table.style.width= t_width.value+'px'; }

                }} // set.onclick()

        } // table_renew()



        function copy_table(){
            copy.onclick=function(){
                if(task==3){
                    let yes=window.confirm(
                        "ã€€ğŸ”µ é¸æŠã—ãŸè¡¨ã®ã€Œè¨­å®šã€ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦\n"+
                        "ã€€ã€€  æ–°è¦ä½œæˆã®è¡¨ã®åˆæœŸå€¤ã«ã—ã¾ã™");
                    if(yes){
                        setting[1]=col.value;
                        setting[2]=row.value;
                        setting[3]=posit_set;
                        setting[4]=t_width.value;
                        setting[6]=add_padd;
                        setting[7]=border_width.value;
                        setting[8]=left_full;
                        setting[9]=border_color.value;
                        setting[10]=header_back.value;
                        setting[11]=left_back.value;
                        setting[12]=cell_back.value;
                        setting[13]=t_font.value;
                        setting[14]=layout_fix;
                        setting[15]=word_break;

                        write_locals(setting); }}}} // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ä¿å­˜

    } // edit_table()



    function set_css(){
        let t_width=document.querySelector('#t_width'); // è¡¨å…¨å¹…ã®è¨­å®š
        let border_color=document.querySelector('#border_color'); // æ ç·šè‰²ã®è¨­å®š
        let cell_back=document.querySelector('#cell_back'); // å…¨ä½“èƒŒæ™¯è‰²ã®è¨­å®š
        let t_font=document.querySelector('#t_font'); // æ–‡å­—ã‚µã‚¤ã‚ºã®è¨­å®š

        let css=
            'width: '+ t_width.value +'px; '+
            'margin: '+ table_position +'; '+
            'table-layout: '+ layout_fix +'; '+
            'border-collapse: '+ border_collapse +'; '+
            'border-spacing: '+ border_space +'px; '+
            'border: '+ table_border_width +'px solid '+ border_color.value +'; '+
            'font: normal '+ t_font.value +'px Meiryo; '+
            'background-color: '+ cell_back.value +'; '+
            'word-break: '+ word_break +'; ';

        return css; }



    function new_table_id(){ // è¤‡æ•°tableã‚’ç”Ÿæˆæ™‚ã«ç•°ãªã‚‹idã‚’ä»˜ã‘ã‚‹
        if(document.querySelector('.cke_wysiwyg_frame') !=null){
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            let iframe_doc=editor_iframe.contentWindow.document;
            for(let k=0; k<100; k++){
                let table_id='ambt'+k;
                if(iframe_doc.getElementById(table_id)==null){
                    return table_id; }}}}



    function remove_t_panel(){
        document.querySelector('#t_panel').remove(); }



    function remove_mark(){
        if(document.querySelector('.cke_wysiwyg_frame') !=null){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ã‹ã‚‰å®Ÿè¡Œé–‹å§‹
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            let iframe_doc=editor_iframe.contentWindow.document;

            let active_item=iframe_doc.querySelectorAll('.amb_active');
            for(let k=0; k<active_item.length; k++){
                active_item[k].classList.remove('amb_active'); }}}



    function remove_mark_trim(){
        if(document.querySelector('.cke_wysiwyg_frame') !=null){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ã‹ã‚‰å®Ÿè¡Œé–‹å§‹
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            let iframe_doc=editor_iframe.contentWindow.document;

            let active_trimr=iframe_doc.querySelectorAll('.trimr_active');
            for(let k=0; k<active_trimr.length; k++){
                active_trimr[k].classList.remove('trimr_active'); }

            let active_trimd=iframe_doc.querySelectorAll('.trimd_active');
            for(let k=0; k<active_trimd.length; k++){
                active_trimd[k].classList.remove('trimd_active'); }

            let active_trim=iframe_doc.querySelectorAll('.trim_active');
            for(let k=0; k<active_trim.length; k++){
                active_trim[k].classList.remove('trim_active'); }}}



    function remove_mark_col(){
        if(document.querySelector('.cke_wysiwyg_frame') !=null){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ã‹ã‚‰å®Ÿè¡Œé–‹å§‹
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            let iframe_doc=editor_iframe.contentWindow.document;

            let active_col=iframe_doc.querySelectorAll('.col_active');
            for(let k=0; k<active_col.length; k++){
                active_col[k].classList.remove('col_active'); }}}



    function remove_mark_all(){
        remove_mark();
        remove_mark_trim();
        remove_mark_col(); }



    function show_first(n){
        let first=document.querySelector('#first');
        let bt_help1=document.querySelector('.bt_help1');
        let bt_help2=document.querySelector('.bt_help2');
        let bt_help3=document.querySelector('.bt_help3');
        let bc_help4=document.querySelector('.bc_help4');
        if(first){
            if(n==0){
                first.style.display='none'; }
            else{
                first.style.display='block';
                bt_help1.style.display='none';
                bt_help2.style.display='none';
                bt_help3.style.display='none';
                bc_help4.style.display='none';
                if(n==1){
                    bt_help1.style.display='block'; }
                if(n==2){
                    bt_help2.style.display='block'; }
                if(n==3){
                    bt_help3.style.display='block'; }
                if(n==4){
                    bc_help4.style.display='block'; }}}

        let bt_help=document.querySelector('#bt_help');
        if(bt_help){
            bt_help.onclick=function(){
                let url='https://ameblo.jp/personwritep/entry-12703182424.html';
                window.open(url, target="_blank"); }}}



    function equal_color(R, G, B, A){ // RGBã¯æ•´æ•° Aã¯å°æ•°ãŒå¿…é ˆ â” ç­‰ä¾¡ 6æ¡hexã‚³ãƒ¼ãƒ‰ã«å¤‰æ›
        return '#'
            + tohex(upColor(R, A))
            + tohex(upColor(G, A))
            + tohex(upColor(B, A));

        function upColor(value, A){
            let color_value=value*A + 255*(1 - A);
            return Math.floor(color_value); }

        function tohex(value){
            return ('0'+ value.toString(16)).slice(-2); }}



    function hex_bright(hex){ // æ˜åº¦ã‚’æ®µéšçš„ã«å¤‰æ›
        if(hex.slice(0, 1)=='#'){
            hex=hex.slice(1); }
        if(hex.length==3){
            hex=hex.slice(0,1) + hex.slice(0,1) + hex.slice(1,2) + hex.slice(1,2) +
                hex.slice(2,3) + hex.slice(2,3); }
        // é€éåº¦ 0.6 ã¨ã—ãŸè‰²å€¤ã«å¤‰æ›´
        let R=parseInt(hex.slice(0, 2), 16);
        let G=parseInt(hex.slice(2, 4), 16);
        let B=parseInt(hex.slice(4, 6), 16);

        return equal_color(R, G, B, 0.6); } // éé€éè‰²å€¤ã«å¤‰æ›´



    function hex_8_6(hex){ // 8æ¡hexå€¤ã‚’6æ¡hexã«å¤‰æ›
        if(hex.length!=9 || hex.slice(0, 1)!='#'){
            return hex; }
        else{
            hex=hex.slice(1);

            let R=parseInt(hex.slice(0, 2), 16);
            let G=parseInt(hex.slice(2, 4), 16);
            let B=parseInt(hex.slice(4, 6), 16);
            let A=hex.slice(6, 8);
            // 16é€²ã®ã€ŒAå€¤ã€ã‚’é€éåº¦ï¼ˆå°æ•°ï¼‰ã«å¤‰æ›´
            let alp=0;
            for(let i=0; i<2; i++){
                alp +=Math.pow(16, -(i + 1))*parseInt(A[i], 16); }

            return equal_color(R, G, B, alp); }} // éé€éè‰²å€¤ã«å¤‰æ›´



    function rgb_hex(color){ // rgb or rgba è¡¨è¨˜ã‚’hex6æ¡è¡¨è¨˜ã«å¤‰æ›
        if(color.includes('#')){ // hexè¡¨è¨˜ã®å ´åˆ
            return color; }
        else{ // rgbè¡¨è¨˜ã®å ´åˆ
            color=color.split('(')[1].split(')')[0].replace(/ /g, '');
            let rgb_ar=color.split(',');

            let R=parseInt(rgb_ar[0], 10);
            let G=parseInt(rgb_ar[1], 10);
            let B=parseInt(rgb_ar[2], 10);
            let A;
            if(rgb_ar.length==3){
                A=1; }
            else if(rgb_ar.length==4){
                A=parseFloat(rgb_ar[3]); }

            return equal_color(R, G, B, A); }} // éé€éè‰²å€¤ã«å¤‰æ›´



    function before_end(){
        let submitButton=document.querySelectorAll('.js-submitButton');
        submitButton[0].addEventListener('mousedown', all_clear, false);
        submitButton[1].addEventListener('mousedown', all_clear, false);

        function all_clear(){
            let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
            if(!editor_iframe){ //ã€ŒHTMLè¡¨ç¤ºã€ç·¨é›†ç”»é¢ã®å ´åˆ
                alert("â›”ã€€Blog Table ãŒå‡¦ç†ã‚’çµ‚äº†ã—ã¦ã„ã¾ã›ã‚“\n\n"+
                      "ã€€ã€€ é€šå¸¸è¡¨ç¤ºç”»é¢ã«æˆ»ã‚Š ç·¨é›†ã‚’çµ‚äº†ã—ã¦ãã ã•ã„");
                event.stopImmediatePropagation();
                event.preventDefault(); }
            if(editor_iframe){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ç·¨é›†ç”»é¢ã®å ´åˆ
                remove_mark_all(); } // tableç·¨é›†ãƒ»TRIMãƒ»COLã®ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤
        }} // before_end(

} // main()
